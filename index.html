<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root{--primary:#3498db;--success:#27ae60;--danger:#e74c3c;--light:#ecf0f1;--dark:#2c3e50}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Arial}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#2c3e50}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:20px;text-align:center}
    .header h1{font-weight:300}
    .section{padding:20px}
    .controls{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
    .btn-plain{background:#ddd;color:#222}
    .btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
    .btn-success{background:linear-gradient(135deg,#27ae60,#229954)}
    .input{padding:10px;border-radius:8px;border:1px solid #ddd}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th{background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;padding:10px;text-align:right;font-weight:600}
    td{padding:8px;border-bottom:1px solid #eee;text-align:right}
    .student-name{color:var(--primary);cursor:pointer}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;align-items:center;justify-content:center;padding:20px}
    .modal .content{background:#fff;padding:20px;border-radius:10px;max-width:800px;width:100%;max-height:90vh;overflow:auto;direction:rtl}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:768px){.form-grid{grid-template-columns:1fr}}
    .status{padding:10px;border-radius:8px;margin-bottom:10px}
    .status.off{background:#f8d7da;color:#721c24}
    .status.on{background:#d4edda;color:#155724}
    .small{font-size:13px;color:#666}
    .sync-badge{background:#3498db;color:white;border-radius:12px;padding:2px 8px;font-size:12px;margin-right:5px}
    .pending-badge{background:#f39c12;color:white;border-radius:12px;padding:2px 8px;font-size:12px;margin-right:5px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header section">
      <h1>ğŸ“ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ - Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</h1>
      <p class="small">ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub + ØªØ¹Ø¯ÙŠÙ„ + Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ GitHub</p>
    </div>

    <div class="section">
      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="rawUrlInput" class="input" style="min-width:420px" 
                 placeholder="Ø±Ø§Ø¨Ø· Ù…Ù„Ù Excel Ø¹Ù„Ù‰ GitHub" 
                 value="https://raw.githubusercontent.com/ameen-algmady/grades/main/students.xlsx">
          <button id="setUrlBtn" class="btn btn-plain">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù„Ù</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <button id="loadDataBtn" class="btn btn-success">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
          <button id="addStudentBtn" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
          <button id="manualSyncBtn" class="btn btn-success">ğŸ” Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©</button>
        </div>
      </div>

      <div id="connectionBox" class="status small off" style="margin-top:12px">
        Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        <div id="syncInfo" style="margin-top:5px;font-size:12px">
          <span id="syncStatus" class="sync-badge">ğŸ’¾ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø²Ø§Ù…Ù†Ø©</span>
          <span id="pendingChanges" style="display:none" class="pending-badge">0 ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <input id="searchInput" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ..." style="min-width:260px">
        <select id="classFilter" class="input"><option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option></select>
        <button id="exportExcelBtn" class="btn btn-plain">ğŸ“Š ØªÙ†Ø²ÙŠÙ„ Excel</button>
        <button id="setupGitHubBtn" class="btn btn-plain">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ GitHub</button>
      </div>
    </div>

    <div class="section">
      <div id="statsContainer"></div>
      <div style="overflow-x:auto">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Barcode</th><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
              <th>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</th><th>Ø´ÙÙ‡ÙŠ 1</th><th>ÙˆØ§Ø¬Ø¨Ø§Øª 1</th><th>ØªØ­Ø±ÙŠØ±ÙŠ 1</th><th>Ù…Ø­ØµÙ„Ø© 1</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="studentsTableBody">
            <tr><td colspan="10" style="text-align:center;padding:30px;color:#666">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Edit / Add -->
  <div id="editModal" class="modal">
    <div class="content">
      <h3 id="modalTitle">ØªØ¹Ø¯ÙŠÙ„ Ø·Ø§Ù„Ø¨</h3>
      <form id="studentForm">
        <input type="hidden" id="editStudentId">
        <div class="form-grid" style="margin-top:10px">
          <div>
            <label>Ø§Ù„Ø§Ø³Ù… *</label>
            <input id="editName" class="input" required>
          </div>
          <div>
            <label>Barcode</label>
            <input id="editBarcode" class="input">
          </div>
          <div>
            <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
            <input id="editClass" class="input">
          </div>
          <div>
            <label>ID *</label>
            <input id="editId" class="input" required>
          </div>

          <div>
            <label>Ù…ÙˆØ§Ø¸Ø¨Ø© 1</label>
            <input id="editAttendance1" type="number" step="0.1" class="input" value="0">
          </div>
          <div>
            <label>Ø´ÙÙ‡ÙŠ 1</label>
            <input id="editOral1" type="number" step="0.1" class="input" value="0">
          </div>
          <div>
            <label>ÙˆØ§Ø¬Ø¨Ø§Øª 1</label>
            <input id="editHomework1" type="number" step="0.1" class="input" value="0">
          </div>
          <div>
            <label>ØªØ­Ø±ÙŠØ±ÙŠ 1</label>
            <input id="editWritten1" type="number" step="0.1" class="input" value="0">
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
          <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ ÙˆÙ…Ø²Ø§Ù…Ù†Ø©</button>
          <button type="button" id="cancelBtn" class="btn btn-plain">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal GitHub Setup -->
  <div id="githubSetupModal" class="modal">
    <div class="content" style="max-width:500px">
      <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub</h3>
      <div style="margin-top:15px">
        <label>GitHub Token *</label>
        <input id="githubToken" class="input" style="width:100%;margin-top:5px" 
               placeholder="Ø£Ø¯Ø®Ù„ GitHub Personal Access Token" type="password">
        <p class="small" style="margin-top:8px;color:#666">
          Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Token:<br>
          1. Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens<br>
          2. Ø§Ø®ØªØ± "Tokens (classic)"<br>
          3. Ø£Ù†Ø´Ø¦ token Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª <strong>repo</strong><br>
          4. Ø§Ù„ØµÙ‚ Ø§Ù„Ù€ token Ù‡Ù†Ø§
        </p>
      </div>
      <div style="margin-top:15px">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ GitHub *</label>
        <input id="githubUsername" class="input" style="width:100%;margin-top:5px" 
               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ GitHub">
      </div>
      <div style="margin-top:15px">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ *</label>
        <input id="githubRepo" class="input" style="width:100%;margin-top:5px" 
               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹" value="grades">
      </div>
      <div style="margin-top:15px">
        <label>Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ *</label>
        <input id="githubPath" class="input" style="width:100%;margin-top:5px" 
               placeholder="Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù" value="students.xlsx">
      </div>
      <div style="margin-top:15px;display:flex;gap:8px;justify-content:flex-end">
        <button id="saveGitHubBtn" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button id="cancelGitHubBtn" class="btn btn-plain">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

<script>
/* ================== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ================== */
const DEFAULT_RAW_URL = 'https://raw.githubusercontent.com/ameen-algmady/grades/main/students.xlsx';

/* ========== Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ========== */
const rawUrlInput = document.getElementById('rawUrlInput');
const setUrlBtn = document.getElementById('setUrlBtn');
const loadDataBtn = document.getElementById('loadDataBtn');
const addStudentBtn = document.getElementById('addStudentBtn');
const manualSyncBtn = document.getElementById('manualSyncBtn');
const exportExcelBtn = document.getElementById('exportExcelBtn');
const setupGitHubBtn = document.getElementById('setupGitHubBtn');
const connectionBox = document.getElementById('connectionBox');
const syncStatus = document.getElementById('syncStatus');
const pendingChanges = document.getElementById('pendingChanges');
const searchInput = document.getElementById('searchInput');
const classFilter = document.getElementById('classFilter');
const studentsTableBody = document.getElementById('studentsTableBody');
const editModal = document.getElementById('editModal');
const studentForm = document.getElementById('studentForm');
const cancelBtn = document.getElementById('cancelBtn');
const githubSetupModal = document.getElementById('githubSetupModal');
const githubToken = document.getElementById('githubToken');
const githubUsername = document.getElementById('githubUsername');
const githubRepo = document.getElementById('githubRepo');
const githubPath = document.getElementById('githubPath');
const saveGitHubBtn = document.getElementById('saveGitHubBtn');
const cancelGitHubBtn = document.getElementById('cancelGitHubBtn');

/* Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
const fields = {
  id: document.getElementById('editId'),
  name: document.getElementById('editName'),
  barcode: document.getElementById('editBarcode'),
  class: document.getElementById('editClass'),
  attendance1: document.getElementById('editAttendance1'),
  oral1: document.getElementById('editOral1'),
  homework1: document.getElementById('editHomework1'),
  written1: document.getElementById('editWritten1')
};

/* ========== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ========== */
let RAW_URL = DEFAULT_RAW_URL;
let allStudents = [];
let filteredStudents = [];
let pendingSyncCount = 0;
let isOnline = navigator.onLine;

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub
let GITHUB_CONFIG = {
  token: '',
  username: '',
  repo: 'grades',
  path: 'students.xlsx'
};

const LS_PREFIX = 'grades_sync_';
const LS_KEY_DATA = LS_PREFIX + 'data';
const LS_KEY_RAWURL = LS_PREFIX + 'rawurl';
const LS_KEY_GITHUB = LS_PREFIX + 'github';
const LS_KEY_PENDING = LS_PREFIX + 'pending';

/* ========== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ========== */
function setStatus(text, online = false) {
  const statusElement = connectionBox.querySelector('.status');
  if (statusElement) {
    statusElement.textContent = 'Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ' + text;
  }
  connectionBox.className = 'status small ' + (online ? 'on' : 'off');
}

function updateSyncDisplay() {
  if (pendingSyncCount > 0) {
    pendingChanges.style.display = 'inline';
    pendingChanges.textContent = pendingSyncCount + ' ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
    syncStatus.textContent = 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
    syncStatus.className = 'pending-badge';
  } else {
    pendingChanges.style.display = 'none';
    syncStatus.textContent = 'âœ… Ù…ØªØ²Ø§Ù…Ù† Ù…Ø¹ GitHub';
    syncStatus.className = 'sync-badge';
  }
}

function saveToLocal() {
  localStorage.setItem(LS_KEY_DATA, JSON.stringify(allStudents));
}

function loadFromLocal() {
  try {
    const s = localStorage.getItem(LS_KEY_DATA);
    return s ? JSON.parse(s) : null;
  } catch (e) {
    return null;
  }
}

function saveGitHubConfig() {
  localStorage.setItem(LS_KEY_GITHUB, JSON.stringify(GITHUB_CONFIG));
}

function loadGitHubConfig() {
  try {
    const config = localStorage.getItem(LS_KEY_GITHUB);
    if (config) {
      GITHUB_CONFIG = JSON.parse(config);
      return true;
    }
  } catch (e) {
    console.error('Error loading GitHub config:', e);
  }
  return false;
}

function savePendingCount() {
  localStorage.setItem(LS_KEY_PENDING, pendingSyncCount.toString());
}

function loadPendingCount() {
  try {
    const count = localStorage.getItem(LS_KEY_PENDING);
    pendingSyncCount = count ? parseInt(count) : 0;
    updateSyncDisplay();
  } catch (e) {
    pendingSyncCount = 0;
    updateSyncDisplay();
  }
}

function incrementPendingSync() {
  pendingSyncCount++;
  savePendingCount();
  updateSyncDisplay();
  
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØµÙ„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
  if (isOnline && GITHUB_CONFIG.token) {
    setTimeout(() => syncWithGitHub(), 1000);
  }
}

function saveRawUrlToLocal() {
  localStorage.setItem(LS_KEY_RAWURL, RAW_URL || '');
}

function loadRawUrlFromLocal() {
  const v = localStorage.getItem(LS_KEY_RAWURL);
  if (v) RAW_URL = v;
}

/* ========== ØªØ­Ù…ÙŠÙ„ Excel Ù…Ù† GitHub ========== */
async function fetchExcelFromRaw() {
  if (!RAW_URL) throw new Error('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ raw URL');
  
  setStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub...', false);
  
  const resp = await fetch(RAW_URL);
  
  if (!resp.ok) {
    throw new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù: ${resp.status} ${resp.statusText}`);
  }
  
  const arrayBuffer = await resp.arrayBuffer();
  
  if (arrayBuffer.byteLength === 0) {
    throw new Error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  }
  
  const workbook = XLSX.read(arrayBuffer, {type: 'array'});
  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
  
  return { workbook, rows };
}

/* ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Excel ========== */
function processExcelData(rows) {
  if (!rows || rows.length < 2) return [];
  
  const students = [];
  
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || row.length === 0) continue;
    
    const student = {
      id: (row[0] || `STD${i}`).toString().trim(),
      barcode: (row[1] || '').toString().trim(),
      name: (row[2] || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…').toString().trim(),
      class: (row[3] || '---').toString().trim(),
      attendance1: formatGrade(row[4]),
      oral1: formatGrade(row[5]),
      homework1: formatGrade(row[6]),
      written1: formatGrade(row[7]),
      total1: '0',
      result1: '0'
    };
    
    const total = (parseFloat(student.attendance1) || 0) + 
                  (parseFloat(student.oral1) || 0) + 
                  (parseFloat(student.homework1) || 0) + 
                  (parseFloat(student.written1) || 0);
    
    student.total1 = total.toString();
    student.result1 = (total / 5).toFixed(1);
    
    students.push(student);
  }
  
  return students;
}

function formatGrade(value) {
  if (value === null || value === undefined || value === '') return '0';
  if (typeof value === 'number') return value.toString();
  return value.toString().trim() || '0';
}

/* ========== Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub ========== */
async function syncWithGitHub() {
  if (!GITHUB_CONFIG.token || !isOnline) {
    return false;
  }

  try {
    setStatus('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub...', true);
    syncStatus.textContent = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...';

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† GitHub
    let fileSha = null;
    try {
      const fileInfo = await getGitHubFileInfo();
      fileSha = fileInfo.sha;
    } catch (error) {
      console.log('Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ GitHubØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯');
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const excelBuffer = createExcelBuffer();
    
    // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ GitHub
    await uploadToGitHub(excelBuffer, fileSha);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø©
    pendingSyncCount = 0;
    savePendingCount();
    updateSyncDisplay();
    
    setStatus('ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ GitHub', true);
    return true;
    
  } catch (error) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
    setStatus('ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ GitHub', false);
    syncStatus.textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©';
    return false;
  }
}

async function getGitHubFileInfo() {
  const response = await fetch(
    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,
    {
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    }
  );
  
  if (!response.ok) {
    throw new Error(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù: ${response.status}`);
  }
  
  return await response.json();
}

function createExcelBuffer() {
  const workbook = XLSX.utils.book_new();
  
  const rows = [
    ['ID', 'Barcode', 'Name', 'Class', 'Attendance1', 'Oral1', 'Homework1', 'Written1', 'Total1', 'Result1']
  ];
  
  allStudents.forEach(student => {
    rows.push([
      student.id,
      student.barcode,
      student.name,
      student.class,
      student.attendance1,
      student.oral1,
      student.homework1,
      student.written1,
      student.total1,
      student.result1
    ]);
  });
  
  const worksheet = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(workbook, worksheet, 'Students');
  
  const excelBinary = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
  return excelBinary;
}

async function uploadToGitHub(excelBuffer, sha = null) {
  // ØªØ­ÙˆÙŠÙ„ ArrayBuffer Ø¥Ù„Ù‰ base64
  const base64Content = btoa(
    new Uint8Array(excelBuffer).reduce(
      (data, byte) => data + String.fromCharCode(byte),
      ''
    )
  );
  
  const payload = {
    message: `ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª - ${new Date().toLocaleString('ar-EG')}`,
    content: base64Content,
    branch: 'main'
  };
  
  if (sha) {
    payload.sha = sha;
  }
  
  const response = await fetch(
    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`,
    {
      method: 'PUT',
      headers: {
        'Authorization': `token ${GITHUB_CONFIG.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    }
  );
  
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù: ${response.status} - ${errorData.message || 'Unknown error'}`);
  }
  
  return await response.json();
}

/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ========== */
function updateClassFilter() {
  const classes = Array.from(new Set(allStudents.map(s => s.class || '---'))).sort();
  classFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>';
  classes.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    classFilter.appendChild(opt);
  });
}

function renderStudentsTable() {
  studentsTableBody.innerHTML = '';
  
  if (!filteredStudents || filteredStudents.length === 0) {
    studentsTableBody.innerHTML = 
      '<tr><td colspan="10" style="text-align:center;color:#666;padding:30px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</td></tr>';
    return;
  }
  
  filteredStudents.forEach(s => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${s.id}</td>
      <td>${s.barcode}</td>
      <td><span class="student-name" data-id="${s.id}">${s.name}</span></td>
      <td>${s.class}</td>
      <td>${s.attendance1}</td>
      <td>${s.oral1}</td>
      <td>${s.homework1}</td>
      <td>${s.written1}</td>
      <td>${s.result1}</td>
      <td><button class="btn btn-plain edit-btn" data-id="${s.id}">ØªØ¹Ø¯ÙŠÙ„</button></td>
    `;
    studentsTableBody.appendChild(tr);
  });

  document.querySelectorAll('.student-name').forEach(el => {
    el.addEventListener('click', () => openEditModal(el.dataset.id));
  });
  
  document.querySelectorAll('.edit-btn').forEach(btn => {
    btn.addEventListener('click', () => openEditModal(btn.dataset.id));
  });
}

function applyFilters() {
  const q = (searchInput.value || '').trim().toLowerCase();
  const cls = classFilter.value;
  
  filteredStudents = allStudents.filter(s => {
    const matchQ = !q || 
      (s.name && s.name.toLowerCase().includes(q)) || 
      (s.barcode && s.barcode.toLowerCase().includes(q)) || 
      (s.id && s.id.toString().toLowerCase().includes(q));
    
    const matchC = !cls || s.class === cls;
    return matchQ && matchC;
  });
  
  renderStudentsTable();
  displayStats();
}

function displayStats() {
  const total = filteredStudents.length;
  const totalAll = allStudents.length;
  const syncStatusText = GITHUB_CONFIG.token ? 
    (pendingSyncCount > 0 ? 'â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©' : 'âœ… Ù…ØªØ²Ø§Ù…Ù†') : 
    'âš™ï¸ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯ GitHub';
  
  const html = `
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="background:#f8f9fa;padding:12px;border-radius:8px">Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶ÙŠÙ†: <b>${total}</b></div>
      <div style="background:#e8f8ee;padding:12px;border-radius:8px">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨: <b>${totalAll}</b></div>
      <div style="background:#e8f4fd;padding:12px;border-radius:8px">${syncStatusText}</div>
      ${pendingSyncCount > 0 ? `<div style="background:#fff0f0;padding:12px;border-radius:8px">ğŸ“ ${pendingSyncCount} ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>` : ''}
    </div>
  `;
  document.getElementById('statsContainer').innerHTML = html;
}

/* ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ========== */
function openEditModal(studentId) {
  if (studentId) {
    const s = allStudents.find(x => x.id == studentId);
    if (!s) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    
    document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨';
    fields.id.value = s.id || '';
    fields.name.value = s.name || '';
    fields.barcode.value = s.barcode || '';
    fields.class.value = s.class || '';
    fields.attendance1.value = s.attendance1 || '0';
    fields.oral1.value = s.oral1 || '0';
    fields.homework1.value = s.homework1 || '0';
    fields.written1.value = s.written1 || '0';
  } else {
    document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯';
    studentForm.reset();
    fields.id.value = '';
    fields.attendance1.value = '0';
    fields.oral1.value = '0';
    fields.homework1.value = '0';
    fields.written1.value = '0';
  }
  editModal.style.display = 'flex';
}

function closeEditModal() {
  editModal.style.display = 'none';
}

function openGitHubSetup() {
  githubToken.value = GITHUB_CONFIG.token;
  githubUsername.value = GITHUB_CONFIG.username;
  githubRepo.value = GITHUB_CONFIG.repo;
  githubPath.value = GITHUB_CONFIG.path;
  githubSetupModal.style.display = 'flex';
}

function closeGitHubSetup() {
  githubSetupModal.style.display = 'none';
}

function upsertStudentFromForm() {
  const idVal = (fields.id.value || '').toString().trim();
  const name = (fields.name.value || '').toString().trim();
  
  if (!name || !idVal) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ© (Ø§Ù„Ø§Ø³Ù… Ùˆ ID)');
    return;
  }
  
  const studentObj = {
    id: idVal,
    barcode: (fields.barcode.value || '').toString().trim(),
    name: name,
    class: (fields.class.value || '').toString().trim(),
    attendance1: fields.attendance1.value || '0',
    oral1: fields.oral1.value || '0',
    homework1: fields.homework1.value || '0',
    written1: fields.written1.value || '0'
  };

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
  const total = (parseFloat(studentObj.attendance1) || 0) + 
                (parseFloat(studentObj.oral1) || 0) + 
                (parseFloat(studentObj.homework1) || 0) + 
                (parseFloat(studentObj.written1) || 0);
  
  studentObj.total1 = total.toString();
  studentObj.result1 = (total / 5).toFixed(1);

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙØ¹Ù„ÙŠ
  const existingStudent = allStudents.find(x => x.id == studentObj.id);
  let isChanged = true;
  
  if (existingStudent) {
    isChanged = JSON.stringify(existingStudent) !== JSON.stringify(studentObj);
  }

  // ØªØ­Ø¯ÙŠØ« Ø£Ùˆ Ø¥Ø¶Ø§ÙØ©
  const idx = allStudents.findIndex(x => x.id == studentObj.id);
  if (idx >= 0) {
    allStudents[idx] = studentObj;
  } else {
    allStudents.push(studentObj);
  }
  
  // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
  saveToLocal();
  
  // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø© ÙˆØ§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
  if (isChanged) {
    incrementPendingSync();
  }
  
  applyFilters();
  closeEditModal();
  
  // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
  if (GITHUB_CONFIG.token && isOnline) {
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù…Ø¹ GitHub...');
  } else {
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹! Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ¥Ø¹Ø¯Ø§Ø¯ GitHub.');
  }
}

/* ========== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© ========== */
async function loadExcelAndInit() {
  try {
    const { rows } = await fetchExcelFromRaw();
    const newStudents = processExcelData(rows);
    
    if (newStudents.length === 0) {
      throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ù„Ù');
    }
    
    allStudents = newStudents;
    saveToLocal();
    applyFilters();
    updateClassFilter();
    
    setStatus(`ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ - ${allStudents.length} Ø·Ø§Ù„Ø¨`, true);
    
  } catch (err) {
    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub:', err);
    
    const local = loadFromLocal();
    if (local && local.length > 0) {
      allStudents = local;
      applyFilters();
      updateClassFilter();
      setStatus(`ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ - ${allStudents.length} Ø·Ø§Ù„Ø¨`, false);
    } else {
      setStatus('ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ - Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª', false);
      studentsTableBody.innerHTML = 
        '<tr><td colspan="10" style="text-align:center;padding:30px;color:#c00">âŒ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    }
  }
}

function loadLocalData() {
  const local = loadFromLocal();
  if (local && local.length > 0) {
    allStudents = local;
    applyFilters();
    updateClassFilter();
    setStatus(`ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ - ${allStudents.length} Ø·Ø§Ù„Ø¨`, true);
    return true;
  }
  return false;
}

/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ========== */
setUrlBtn.addEventListener('click', () => {
  const v = (rawUrlInput.value || '').trim();
  if (!v) return alert('Ø£Ø¯Ø®Ù„ raw URL Ù„Ù„Ù…Ù„Ù Ø£ÙˆÙ„Ø§Ù‹.');
  RAW_URL = v;
  saveRawUrlToLocal();
  loadExcelAndInit();
});

loadDataBtn.addEventListener('click', () => {
  loadExcelAndInit();
});

manualSyncBtn.addEventListener('click', () => {
  if (!GITHUB_CONFIG.token) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯ GitHub Ø£ÙˆÙ„Ø§Ù‹');
    openGitHubSetup();
    return;
  }
  syncWithGitHub();
});

exportExcelBtn.addEventListener('click', () => {
  const excelBuffer = createExcelBuffer();
  const blob = new Blob([excelBuffer], {type: 'application/octet-stream'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `students_backup_${new Date().toISOString().slice(0,10)}.xlsx`;
  a.click();
  URL.revokeObjectURL(url);
});

setupGitHubBtn.addEventListener('click', openGitHubSetup);

saveGitHubBtn.addEventListener('click', () => {
  const token = githubToken.value.trim();
  const username = githubUsername.value.trim();
  const repo = githubRepo.value.trim();
  const path = githubPath.value.trim();
  
  if (!token || !username || !repo || !path) {
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
    return;
  }
  
  GITHUB_CONFIG = { token, username, repo, path };
  saveGitHubConfig();
  closeGitHubSetup();
  updateSyncDisplay();
  displayStats();
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub Ø¨Ù†Ø¬Ø§Ø­!');
});

cancelGitHubBtn.addEventListener('click', closeGitHubSetup);

searchInput.addEventListener('input', applyFilters);
classFilter.addEventListener('change', applyFilters);
addStudentBtn.addEventListener('click', () => openEditModal(null));
cancelBtn.addEventListener('click', closeEditModal);

studentForm.addEventListener('submit', (e) => {
  e.preventDefault();
  upsertStudentFromForm();
});

/* ========== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ========== */
document.addEventListener('DOMContentLoaded', () => {
  loadRawUrlFromLocal();
  loadGitHubConfig();
  loadPendingCount();
  rawUrlInput.value = RAW_URL;
  
  // Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
  if (!loadLocalData()) {
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub
    if (isOnline && RAW_URL) {
      setTimeout(() => loadExcelAndInit(), 500);
    }
  }
  
  displayStats();
});

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
window.addEventListener('online', () => {
  isOnline = true;
  setStatus('Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', true);
  
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø§ØªØµØ§Ù„
  if (pendingSyncCount > 0 && GITHUB_CONFIG.token) {
    setTimeout(() => syncWithGitHub(), 2000);
  }
});

window.addEventListener('offline', () => {
  isOnline = false;
  setStatus('ØºÙŠØ± Ù…ØªØµÙ„', false);
});
</script>
</body>
</html>